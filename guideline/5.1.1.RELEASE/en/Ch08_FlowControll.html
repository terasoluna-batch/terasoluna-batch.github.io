<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Flow control</title>
<link rel="stylesheet" href="./theme/css/readthedocs.css">
<link rel="stylesheet" href="./theme/css/font-awesome.min.css">
<link rel="stylesheet" href="./theme/css/coderay-asciidoctor.css">
<link rel="stylesheet" href="./theme/css/header-footer.css">
<title>TERASOLUNA Batch Framework for Java (5.x) Development Guideline</title>

<div class="common-bg">
  <div class="information">
    TERASOLUNA Batch Framework for Java (5.x) Development Guideline - version 5.1.1.RELEASE, 2018-3-16
  </div>
  <div class="index">
    <a href="index.html">&gt; INDEX</a>
  </div>
</div>
</head>
<body id="Ch08_FlowControll" class="book toc2 toc-left">
<div id="header">
<h1>Flow control</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#Ch08_FlowControll_Overview">Overview</a></li>
<li><a href="#Ch08_FlowControll_HowToUse">How to use</a>
<ul class="sectlevel2">
<li><a href="#Ch08_FlowControll_HowToUse_SequencialFlow">Sequential flow</a></li>
<li><a href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps">Passing data between steps</a>
<ul class="sectlevel3">
<li><a href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Tasklet">Data passing between steps using tasklet model</a></li>
<li><a href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Chunk">Data passing between steps using the chunk model</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch08_FlowControll_HowToExtend">How to extend</a>
<ul class="sectlevel2">
<li><a href="#Ch08_FlowControll_HowToExtend_ConditionFlow">Conditional branching</a></li>
<li><a href="#Ch08_FlowControll_HowToExtend_StopConfig">Stop condition</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="Ch08_FlowControll_Overview"><a class="anchor" href="#Ch08_FlowControll_Overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is a method of implementing a single business process by splitting one job to multiple jobs and combining them
instead of implementing by integrating them in one job.
The item wherein dependency relationship between jobs is defined, is called as job net.</p>
</div>
<div class="paragraph">
<p>The advantages of defining a job net are enumerated below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is easier to visualize progress status of a process</p>
</li>
<li>
<p>It is possible to do partial re-execution,  pending execution and stop execution of jobs</p>
</li>
<li>
<p>It is easier to do parallel execution of jobs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As described above, when designing batch processing, it is common to design the job net and the jobs together.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Suitability of Processing Contents and Job Net</div>
<div class="paragraph">
<p>Job nets are often not suitable for simple business process that does not need to be splitted and processing that cooperates with the online process.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this guideline, controlling the flow of jobs between job nets is called flow control.
In the processing flow, the previous job is called as preceding job and the next job is called as subsequent job.
The dependency relationship between the preceding job and the subsequent job is called preceding and succeeding relationship.</p>
</div>
<div class="paragraph">
<p>The conceptual diagram of flow control is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_FlowControl_Overview.png" alt="Flow Control Overview">
</div>
<div class="title">Overview of flow control</div>
</div>
<div class="paragraph">
<p>As shown above, flow control can be implemented by both the job scheduler and TERASOLUNA Batch 5.x.
However, it is desirable to use the job scheduler as much as possible due to the following reasons.</p>
</div>
<div class="ulist">
<div class="title">When implemented in TERASOLUNA Batch 5.x</div>
<ul>
<li>
<p>There is a strong tendency to have diverse processes and status for one job making it easier to form a black box.</p>
</li>
<li>
<p>The boundary between the job scheduler and the job becomes ambiguous</p>
</li>
<li>
<p>It becomes difficult to see the situation at the time of abnormality from the job scheduler</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, it is generally known that there are following disadvantages when the number of jobs defined in the job scheduler increases.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following costs are accumulated by the job scheduler, and the processing time of the entire system increases.</p>
<div class="ulist">
<ul>
<li>
<p>Job scheduler product specific communication, control of execution node, etc.</p>
</li>
<li>
<p>Overhead cost associated with Java process start for each job</p>
</li>
</ul>
</div>
</li>
<li>
<p>Number of job registrations limit</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The policy is as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Basically, flow control is performed by the job scheduler.</p>
</li>
<li>
<p>Following measures are taken only when any damage is caused due to the large number of jobs.</p>
<div class="ulist">
<ul>
<li>
<p>Multiple sequential processes are consolidated in one job in TERASOLUNA Batch 5.x.</p>
<div class="ulist">
<ul>
<li>
<p>Simple preceding and succeeding relationships are only consolidated in one job.</p>
</li>
<li>
<p>The change of the step exit code and the conditional branch of the subsequent step activation based on this exit code can be functionally used,
however, since job execution management becomes complicated, in principle,
only the process exit code determination at the end of the job is used.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Refer to <a href="Ch07_JobManagement.html#Ch07_JobManagement_HowToUse_ExitCode">"Customization of exit code"</a> for the details of deciding job exit code.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The points to be considered for implementing preceding and succeeding processes are shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch08/FlowControl/Ch08_FlowControl_Jobnet.png" alt="Job net">
</div>
<div class="title">Flow control by job scheduler</div>
</div>
<div class="ulist">
<div class="title">Points to be considered</div>
<ul>
<li>
<p>Job scheduler starts java process through shell.</p>
</li>
<li>
<p>One job should correspond to one java process.</p>
<div class="ulist">
<ul>
<li>
<p>In the entire process, 4 java processes start.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The job scheduler controls the start order of each process. Each java process is independent.</p>
</li>
<li>
<p>The process exit code of the preceding job is used for deciding the start of the succeeding job.</p>
</li>
<li>
<p>External resources such as files, database etc. should be used to pass the data between jobs.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch08/FlowControl/Ch08_FlowControl_StepExecution.png" alt="FlowControl">
</div>
<div class="title">Flow control by TERASOLUNA Batch 5.x</div>
</div>
<div class="ulist">
<div class="title">Points to be considered</div>
<ul>
<li>
<p>Job scheduler starts java process through shell.</p>
</li>
<li>
<p>One job should be one java process.</p>
<div class="ulist">
<ul>
<li>
<p>In the entire process, only one java process is used.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Start order of each step is controlled by one java process. Each step is independent.</p>
</li>
<li>
<p>The exit code of the preceding job is used for deciding the start of the succeeding job.</p>
</li>
<li>
<p>The data can be passed between steps by in-memory.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How to implement flow control by TERASOLUNA Batch 5.x is explained below.<br>
The flow control of job scheduler is strongly dependent on the product specifications so it is not explained here.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Application example of flow control</div>
<div class="paragraph">
<p>In general, parallel/multiple processes of multiple jobs are often implemented by job scheduler and job net.<br>
However, in TERASOLUNA Batch 5.x, how to implement parallel and multiple processes of multiple jobs by applying the flow control function, is explained.
Refer to <a href="Ch08_ParallelAndMultiple.html#Ch08_ParallelAndMultiple">"Parallel and multiple process"</a> for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The usage method of this function is same in the chunk model as well as tasklet model.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch08_FlowControll_HowToUse"><a class="anchor" href="#Ch08_FlowControll_HowToUse"></a>How to use</h2>
<div class="sectionbody">
<div class="paragraph">
<p>How to use flow control in TERASOLUNA Batch 5.x is explained.</p>
</div>
<div class="sect2">
<h3 id="Ch08_FlowControll_HowToUse_SequencialFlow"><a class="anchor" href="#Ch08_FlowControll_HowToUse_SequencialFlow"></a>Sequential flow</h3>
<div class="paragraph">
<p>A sequential flow is a flow in which preceding step and succeding step are connected in series.<br>
If any business process ends abnormally in a step of the sequential flow, the succeeding step is not executed and the job is interrupted.
In this case, the step and job status and exit code associated with the job execution ID are
recorded as <code>FAILED</code> by <code> JobRepository</code>.<br>
By restarting after recovering the cause of failure, it is possible to resume the process from the abnormally ended step.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Refer to <a href="Ch06_ReProcessing.html#Ch06_RerunRestart_HowToUse_Restart">"Job restart"</a> for how to restart a job.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here, a sequential flow of the jobs having 3 steps is set.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sequentialFlowTasklet</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch08.flowcontrol.SequentialFlowTasklet</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:failExecutionStep</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['failExecutionStep']}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sequentialFlowTasklet</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step1</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>   <span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the next step to be started after this step ends normally in <code>&lt;batch:step&gt;</code>.<br>
Set <code>id</code> of the next step to <code>next</code> attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>next</code> attribute is not required in the step at the end of the flow.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As a result, steps are started in series in the following order.<br>
<code>jobSequentialFlow.step1</code> &#8594; <code>jobSequentialFlow.step2</code> &#8594; <code>jobSequentialFlow.step3</code><br></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">How to define using &lt;batch:flow&gt;</div>
<div class="paragraph">
<p>In the above example, the flow is directly defined in <code> &lt;batch: job&gt; </code>.
Flow definition can be defined outside using <code>&lt;batch:flow&gt;</code>.
An example of using <code>&lt;batch:flow&gt;</code> is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:flow</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">innerFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outerFlow</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;batch:flow</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outerFlow</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step1</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step3</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step3</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:flow&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set flow id defined in (2) to the parent attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define sequential flow.</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch08_FlowControll_HowToUse_PassingDataToFutureSteps"><a class="anchor" href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps"></a>Passing data between steps</h3>
<div class="paragraph">
<p>In Spring Batch, <code>ExecutionContext</code> of execution context that can be used in the scope of each step and job is provided.
By using the step execution context, data can be shared between the components in the step.
At this time, since the step execution context cannot be shared between steps, the preceding step execution context cannot be referred from the succeeding step execution context.
It can be implemented if the job execution context is used, but since it can be referred from all steps, it needs to be handled carefully.
When the information between the steps needs to be inherited, it can be done by the following procedure.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the post-processing of the preceding step, the information stored in the step execution context is passed to the job execution context.</p>
</li>
<li>
<p>The succeeding step gets information from the job execution context.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>By using <code>ExecutionContextPromotionListener</code> provided by Spring Batch,
the first procedure can be realized only by specifying the inherited information to the listener even without implementing it.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Notes on using ExecutionContext</div>
<div class="paragraph">
<p><code> ExecutionContext</code> used for passing data is saved in serialized state in
<code>BATCH_JOB_EXECUTION_CONTEXT</code> and <code>BATCH_JOB_STEP_EXECUTION_CONTEXT</code> of RDBMS
so note the following 3 points.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The passed data should be an object in a serializable format.</p>
<div class="ulist">
<ul>
<li>
<p><code>java.io.Serializable</code> should be implemented.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Minimum required passed data should be retained.<br>
<code> ExecutionContext</code> is also used for storing execution control information by Spring Batch,
 so larger the passed data, the more the serialization cost.<br></p>
</li>
<li>
<p>The above <code> ExecutionContextPromotionListener</code> should be used for passed data without saving it directly in the job execution context.<br>
The job execution context has a wider scope than the step execution context, unnecessary serialized data gets easily accumulated.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Also, it is possible to exchange information by sharing Bean of Singleton or Job scope rather than going through the execution context.
Note that if the method is too large, it may put pressure on memory resources.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The data passed between steps is explained for the tasklet model and the chunk model respectively below.</p>
</div>
<div class="sect3">
<h4 id="Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Tasklet"><a class="anchor" href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Tasklet"></a>Data passing between steps using tasklet model</h4>
<div class="paragraph">
<p>In order to save and fetch passing data, get <code>ExecutionContext</code> from <code> ChunkContext</code> and pass the data between the steps.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of data passing source Tasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package, imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SavePromotionalTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (1)</span>
        chunkContext.getStepContext().getStepExecution().getExecutionContext()
                .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation example of data passing destination Tasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ConfirmPromotionalTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) {
        <span class="comment">// (2)</span>
        <span class="predefined-type">Object</span> promotion = chunkContext.getStepContext().getJobExecutionContext()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Description example of job Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- import,annotation,component-scan definitions are omitted --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">savePromotionalTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener&gt;</span>
                <span class="comment">&lt;!-- (3) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.listener.ExecutionContextPromotionListener</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listener&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">confirmPromotionalTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>
<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Explanation of implementation contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the value to be passed to the after step in the <code> ExecutionContext</code> of the step execution context.
Here, <code> promotion</code> is specified as the key required for a series of data passing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the passing data set in (1) of the preceding step using <code>promotion</code> key specified
in the passing source from <code>ExecutionContext</code>.<br>
Note that the <code>ExecutionContext</code> used here is not the step execution context of (1) but
is the job execution context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using <code>ExecutionContextPromotionListener</code>,
pass the data from the step execution context to the job execution context.<br>
Specify the passing key specified in (1) to <code>keys</code> property.<br>
<code>IllegalArgumentException</code> is thrown by <code>strict=true</code> property when it does not exist in the step execution context.
In case of <code> false</code>, processing continues even if there is no passing data.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Regarding ExecutionContextPromotionListener and step exit code</div>
<div class="paragraph">
<p><code>ExecutionContextPromotionListener</code> passes the data from step execution context to job execution context
only when the step exit code of data passing source ends normally (<code>COMPLETED</code>).<br>
To customize the exit code in which the succeeding step is executed continuously,
exit code should be specified in <code>status</code> property in the array format.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Chunk"><a class="anchor" href="#Ch08_FlowControll_HowToUse_PassingDataToFutureSteps_Chunk"></a>Data passing between steps using the chunk model</h4>
<div class="paragraph">
<p>Use the method assigned with <code>@AfterStep</code> and <code>@BeforeStep</code> annotation in <code>ItemProcessor</code>.
The listener to be used for data passing and how to use <code> ExecutionContext</code> is the same as the tasklet model.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of data passing source ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PromotionSourceItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(<span class="predefined-type">String</span> item) {
        <span class="comment">// omitted.</span>
    }

    <span class="annotation">@AfterStep</span>
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        <span class="comment">// (1)</span>
        stepExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation example of data passing target ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PromotionTargetItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(<span class="predefined-type">String</span> item) {
        <span class="comment">// omitted.</span>
    }

    <span class="annotation">@BeforeStep</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="comment">// (2)</span>
        <span class="predefined-type">Object</span> promotion = stepExecution.getJobExecution().getExecutionContext()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>);
        <span class="comment">// omitted.</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Description example of job Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- import,annotation,component-scan definitions are omitted --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sourceStep</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener&gt;</span>
                <span class="comment">&lt;!-- (3) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.listener.ExecutionContextPromotionListener</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listener&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- step definitions are omitted. --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Explanation of implementation contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the value to be passed to the succeeding step to <code>ExecutionContext</code> of step execution context.
Here, <code> promotion</code> is specified as the key required for a series of data passing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the passing data set in (1) of the preceding step using <code>promotion</code> key specified in the passing source
from <code>ExecutionContext</code>.<br>
Note that the <code>ExecutionContext</code> used here is not the step execution context of (1) but
is the job execution context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using <code>ExecutionContextPromotionListener</code>,
pass the data from the step execution context to the job execution context.<br>
Specification of property is same as the tasklet.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch08_FlowControll_HowToExtend"><a class="anchor" href="#Ch08_FlowControll_HowToExtend"></a>How to extend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here, the conditional branch of the succeeding step and the stop condition to stop the job before the execution of succeeding step according to the condition is described.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Difference between exit code and status of job and step.</div>
<div class="paragraph">
<p>In the following explanation, the terms "Status" and "Exit code" frequently appear.<br>
If these discrimination cannot be done, there is a possibility of confusion,
please refer the <a href="Ch07_JobManagement.html#Ch07_JobManagement_HowToUse_ExitCode">Customization of exit code</a> first.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="Ch08_FlowControll_HowToExtend_ConditionFlow"><a class="anchor" href="#Ch08_FlowControll_HowToExtend_ConditionFlow"></a>Conditional branching</h3>
<div class="paragraph">
<p>The conditional branch means receiving the exit code which is the execution result of the preceding step, selecting one from multiple after steps and continuing execution.<br>
To stop the job without executing any succeeding step, refer to <a href="#Ch08_FlowControll_HowToExtend_StopConfig">"Stop condition"</a>.</p>
</div>
<div class="listingblock">
<div class="title">Description example Job Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepB</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepB</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Explanation of implementation contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not specify <code>next</code> attribute in the <code>&lt;batch:step&gt;</code> element as in the sequential flow.
By setting multiple <code>&lt;batch:next&gt;</code>, it can be assigned to the succeeding step specified by <code>to</code> attribute.<br>
Specify exit code of the step  that is the transition condition, in <code>on</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is the succeeding step executed only when the step exit code of (1) is <code>COMPLETED</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is the succeeding step executed only when the step exit code of (1) is <code>FAILED</code>.<br>
By specifying this, succeeding step such as recovery process etc. is executed without stopping the job when the preceding step process fails.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Notes on recovery process by after steps</div>
<div class="paragraph">
<p>When recovery process of the succeeding step is performed due to failure of preceding step process (Exit code is <code>FAILED</code>),
the status of before step changes to <code>ABANDONED</code> and it cannot restart regardless of success or failure of the recovery process.</p>
</div>
<div class="paragraph">
<p>When the recovery process of the succeeding step fails, only the recovery process is re-executed on restarting the job.<br>
For this reason, when processing is to be performed again including the preceding step, it is necessary to rerun as another job execution.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch08_FlowControll_HowToExtend_StopConfig"><a class="anchor" href="#Ch08_FlowControll_HowToExtend_StopConfig"></a>Stop condition</h3>
<div class="paragraph">
<p>How to stop the job depending on the exit code of the preceding step, is explained.<br>
There are methods to specify the following 3 elements as means to stop.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>end</code></p>
</li>
<li>
<p><code>fail</code></p>
</li>
<li>
<p><code>stop</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If these exit codes correspond to the preceding step, the succeeding step is not executed.<br>
Multiple exit codes can be specified within the same step.</p>
</div>
<div class="listingblock">
<div class="title">Description example of job Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:end</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">END_WITH_NO_EXIT_CODE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:end</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">END_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED_CUSTOM</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;batch:fail</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_FAIL_WITH_NO_EXIT_CODE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:fail</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_FAIL_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED_CUSTOM</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;batch:stop</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_STOP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restart</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Explanation of setting contents of job stop</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>on</code> attribute of <code>&lt;batch:end&gt;</code> and the step exit code match, the job is recorded as normal end
(Status : <code>COMPLETED</code>) in <code>JobRepository</code>.<br>
When <code>exit-code</code> attribute is assigned, exit code of job can be customized from <code>COMPLETED</code> by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By specifying wildcard (<code>*</code>) in <code>on</code> attribute of <code>&lt;batch:next&gt;</code>, when it does not correspond to any of <code>end</code>, <code>fail</code>,
<code>stop</code>, subsequent job can be continued.<br>
It is described at the end of step elements however, since matching condition of exist code is evaluated before,
the arrangement order of elements is optional if it is within step elements.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>&lt;batch:fail&gt;</code> is used, the job is recorded as abnormal end (Status: <code>FAILED</code>) in <code>JobRepository</code>.<br>
Like <code>&lt;batch:end&gt;</code>, by assigning <code>exit-code</code> attribute, exit code of job can be customized from <code>FAILED</code> by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>&lt;batch:stop&gt;</code> is used, the job is recorded as stopped (Status: <code>STOPPED</code>) in <code>JobRepository</code> at the time of normal end of step.<br>
For <code>restart</code> attribute, specify the stop where the job is resumed from stop at the time of restart.<br>
Like <code>&lt;batch:end&gt;</code>, <code>exit-code</code> attribute can be assigned, however, null string should be specified.(refer to column later)</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">When customizing the exit code by the exit-code attribute, it should be mapped to the process exit code without omission.</div>
<div class="paragraph">
<p>Refer to <a href="Ch07_JobManagement.html#Ch07_JobManagement_HowToUse_ExitCode">"Customization of exit code"</a> for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Empty charactor string should be specified to exit-code in &lt;batch:stop&gt;.</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;stop</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restart</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The expected flow control should be that when step1 ends normally, the job stops and step2 is executed when restart is executed again.<br>
However, due to some failure in Spring Batch, the operation does not take place as expected.<br>
step2 is not executed after restart, the exit code of job becomes <code>NOOP</code> and status <code>COMPLETED</code>.</p>
</div>
<div class="paragraph">
<p>To avoid this, "" (empty charactor string) should be assigned in <code>exit-code</code> as shown above.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://jira.spring.io/browse/BATCH-2315">Spring Batch/BATCH-2315</a> for the details of failure.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="container">

  <div class="common-bg">
    <div class="information">
      TERASOLUNA Batch Framework for Java (5.x) Development Guideline - version 5.1.1.RELEASE, 2018-3-16
    </div>
    <div class="index">
      <a href="index.html">&gt; INDEX</a>
    </div>
  </div>

  <div class="footer-bg">
    <div class="copyright">
      &copy; Copyright 2019 NTT DATA Corporation. &copy; Copyright 2019 NTT Corporation.
    </div>
  </div>

</div>
</body>
</html>